{% extends 'base/base.html' %} 

{% block page_title %} {{ _('Data Analysis') }} {% endblock %}

{% block page_content %}
<div class="row" id="app">
  <!-- Dynamic add fields and sensors -->
  <div v-for="(item, index) in fieldsSensors" :key="index">
    <!-- Field -->
    <div class="col-sm-6 col-xs-12">
      <label :for="'field' + index">{{ _('Field') }}{{ '{{ index + 1 }}' }}:</label>
      <select class="form-control" :id="'field' + index" v-model="item.active_field" @change="field_change(index)">
        <template v-for="field in fields">
          <option :value="field.name">{{ '{{ field.alias }}' }}</option>
        </template>
      </select>
    </div>
    <!-- Sensor -->
    <div class="col-sm-6 col-xs-12">
      <label :for="'sensor' + index">{{ _('Sensor') }}{{ '{{ index + 1 }}' }}:</label>
      <select class="form-control" :id="'sensor' + index" v-model="item.active_sensor">
        <template v-for="sensor in item.active_sensors">
          <option :value="sensor.df_name">{{ '{{ sensor.alias }}' }}</option>
        </template>
      </select>
    </div>
  </div>
  
  <!-- Add fields and sensors (Button) -->
  <div class="col-sm-2 col-xs-6">
    <br>
    <button class="btn btn-primary" style="width: 100%;" @click="addFieldSensor">{{ _('Add Field and Sensor') }}</button>
    <br>
  </div>
  <div class="clearfix"></div>


  <!-- start time -->
  <div class="col-sm-4 col-xs-12">
    <label for="start-time">{{ _('StartTime') }}: </label>
    <div class="input-group date">
      <div class="input-group-addon">
        <i class="fa fa-calendar"></i>
      </div>
      <input class="form-control" type='date' id="start-time" />
    </div>
  </div>

  <!-- end time -->
  <div class="col-sm-4 col-xs-12">
    <label for="end-time">{{ _('EndTime') }}: </label>
    <div class="input-group date">
      <div class="input-group-addon">
        <i class="fa fa-calendar"></i>
      </div>
      <input class="form-control" type='date' id="end-time" />
    </div>
  </div>

  <!-- interval -->
  <div class="col-sm-4 col-xs-12">
    <label for="interval">{{ _('Interval') }}:</label>
    <select class="form-control" id="interval">
      <option value="second">{{ _('Second') }}</option>
      <option value="minute">{{ _('Minute') }}</option>
      <option value="hour" selected>{{ _('Hour') }}</option>
      <option value="day">{{ _('Day') }}</option>
    </select>
  </div>

  <!-- analysis option -->  
  <div class="col-sm-3 col-xs-12">
    <br>  
    <label for="plotmethod">{{ _('Data Analysis') }}:</label>
    <select class="form-control" v-model="selectedMethod" @change="executeMethod">
      <!-- 繪圖方法選項 -->
      <optgroup label="{{ _('Visualization') }}">
        <option value="bar">{{ _('Bar') }}</option>
	<option value="box">{{ _('Box') }}</option>
	<option value="calendar_heatmap">{{ _('Calendar Heatmap') }}</option>
	<option value="heatmap">{{ _('HeatMap') }}</option>
	<option value="histogram">{{ _('Histogram') }}</option>
	<option value="line" selected>{{ _('Line') }}</option>
	<option value="scatter">{{ _('Scatter') }}</option>
      </optgroup>
      <!-- 其他分析方法選項 -->
      <optgroup label="{{ _('Advanced Methods') }}">
	<option value="cluster">{{ _('Cluster') }}</option>
	<option value="matrix">{{ _('Correlation Matrix') }}</option>
	<option value="outlier">{{ _('Outlier') }}</option>
	<option value="stl">{{ _('STL Decomposition') }}</option>
      </optgroup>
    </select>
  </div>

  <!-- 動態顯示輸入框，僅當選擇 outlier 方法時才顯示 -->
  <div class="col-sm-4 col-xs-12" v-if="selectedMethod === 'outlier'">
    <br>
    <label for="zscore-input">{{ _('Z-Score threshold') }}:</label>
    <div class="input-group">
      <input id="zscore-input" type="number" v-model="zscoreThreshold" step="0.1" min="0" max="5">
    </div>
  </div>
  
  <!-- interactive chart -->
  <div class="col-xs-12">
    <br>
    <div class="box box-primary">
      <div class="box-header with-border">
        <i class="fa fa-bar-chart-o"></i>
        <h3 class="box-title">{{ _('History Histogram') }}</h3>
        <div class="box-tools pull-right"></div>
      </div>
      <div class="box-body">
        <div id="interactive" style="height: 500px;"></div></div>
      </div>
    </div>  
  </div>  
  
  <!-- 在 AJAX 請求中添加 CSRF token -->
  <meta name="csrf-token" content="{{ csrf_token() }}"> 
</div>
{% endblock %}


{% block page_script %}
<!-- Page script -->
<script>
  function getData(callback) {
    let fields = app.fieldsSensors.map(item => item.active_field);
    let sensors = app.fieldsSensors.map(item => item.active_sensor);
    let starttime = $('#start-time')[0].value;
    let endtime = $('#end-time')[0].value + " 23:59:59";
    let interval = $('#interval').val();

    $.ajax({
      'url': '/api/dynamic_datas',
      'data': {
        f: fields,
        s: sensors,
        st: starttime,
        et: endtime,
        i: interval
      },
      'traditional': true
    }).done((data) => {
      callback(data);
    }).fail(() => {
      callback();
    });
  }


  function update() {
    getData((data) => {
      if (!data) { // 如果數據為空則返回，不進行繪圖
        return;
      }

      let interval = $('#interval').val();
      let plotmethod = $('#plotmethod').val();
      let traces = [];         // 用來存儲所有的 traces

      // 根據interval取資料，並且準備trace資料
      for (let sensor in data) {
        for (let field in data[sensor]) {
          let sensorData = data[sensor][field];
          let timestamps = [];
          if (interval === 'day') {
            timestamps = sensorData.map(item => `${item.date}`);
          } else if (interval === 'hour') {
            timestamps = sensorData.map(item => `${item.date} ${item.hour}:00:00`);
          } else if (interval === 'minute') {
            timestamps = sensorData.map(item => `${item.date} ${item.hour}:${item.minute}:00`);
          } else {
            timestamps = sensorData.map(item => item.timestamp); // 完整的時間戳
          }
          let values = sensorData.map(item => parseFloat(item.value));
          // 準備 trace 資料
          traces.push({
            timestamps: timestamps,
            values: values,
            field: field,
            sensor: sensor
          });
        }
      }

      // 將預處理後的資料發送到後端，並進行一次 AJAX 請求
      $.ajax({
        url: '/api/plotly',
	type: 'POST',
        contentType: 'application/json',
        headers: {
	  'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')  // 加入 CSRF token
	},
	data: JSON.stringify({
          traces: traces,  // 發送所有的 traces
	  plotmethod: plotmethod
	}),
	success: function(response) {
	  console.log("Response:", response);
	  // 從 response 中提取 traces 和 layout 進行繪圖
	  Plotly.newPlot('interactive', response.traces, response.layout).then(() => { // 顯示後端返回的圖表
	    document.getElementById('interactive').style.height = '100%'; // 當圖表繪製完成後，將高度設置為 100%
          });
        },
	error: function(error) {
	  console.error("Error generating plot: ", error);
	}
      });
    });
  }
  
  
  function getTraces(selectedMethod, callback) {
    getData((data) => {
      if (!data) { // 如果數據為空則返回，不進行繪圖
        return;
      }

      let interval = $('#interval').val();
      let traces = [];         // 用來存儲所有的 traces

      // 根據interval取資料，並且準備trace資料
      for (let sensor in data) {
        for (let field in data[sensor]) {
          let sensorData = data[sensor][field];
          let timestamps = [];
          if (interval === 'day') {
            timestamps = sensorData.map(item => `${item.date}`);
          } else if (interval === 'hour') {
            timestamps = sensorData.map(item => `${item.date} ${item.hour}:00:00`);
          } else if (interval === 'minute') {
            timestamps = sensorData.map(item => `${item.date} ${item.hour}:${item.minute}:00`);
          } else {
            timestamps = sensorData.map(item => item.timestamp); // 完整的時間戳
          }
          let values = sensorData.map(item => parseFloat(item.value));
          // 準備 trace 資料
          traces.push({
            timestamps: timestamps,
            values: values,
            field: field,
            sensor: sensor
          });
        }
      }  
      // 回調以處理 traces
      callback(traces, selectedMethod);
    });
  }

  function visualization(traces, plotmethod){
    $.ajax({
      url: '/api/plotly',
      type: 'POST',
      contentType: 'application/json',
        headers: {
	  'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')  // 加入 CSRF token
	},
      data: JSON.stringify({
        traces: traces,  // 發送所有的 traces
	plotmethod: plotmethod
      }),
      success: function(response) {
        console.log("Response:", response);
	// 從 response 中提取 traces 和 layout 進行繪圖
	Plotly.newPlot('interactive', response.traces, response.layout).then(() => { // 顯示後端返回的圖表
	  document.getElementById('interactive').style.height = '100%'; // 當圖表繪製完成後，將高度設置為 100%
        });
      },
      error: function(error) {
        console.error("Error generating plot: ", error);
      }
    });
  }

  
  function stl(traces) {
    // 當欄位有一個以上時，只處理第一組欄位 (trace)
    let field1 = app.fieldsSensors[0].active_field; // 因為stl跟zscore只會處理一個欄位的資料，當使用者有很多欄位時，處理的資料集會是Field1+sensor1
    let sensor1 = app.fieldsSensors[0].active_sensor;
    let active_trace = traces.find(item => item.field === field1 && item.sensor === sensor1);
    const x = active_trace.timestamps;
    const y = active_trace.values;
    
    // 發送數據到後端 API 進行 STL 分解
    $.ajax({
      'url': '/api/stl_decomposition',
      type: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')  // 加入 CSRF token
      },
      data: JSON.stringify({ x: x, y: y }),
      success: function(stl_components) {
        // 獲取後端傳回的圖表 JSON
        const graph_json = stl_components.graph;
        // 更新 STL chart，這裡正確解析 graph_json
        Plotly.newPlot('interactive', JSON.parse(graph_json)).then(() => {
          document.getElementById('interactive').style.height = '100%'; // 當圖表繪製完成後，將高度設置為 100%
        });
      },
      error: function(xhr, status, error) {
        console.error('Error in STL decomposition:', error);
      }
    });    
  }


  function correlation_matrix(traces) {  
    console.log(traces);    
    // 發送數據到後端 API 進行 STL 分解
    $.ajax({
      url: '/api/correlation_matrix',
      type: 'POST',
      contentType: 'application/json',
        headers: {
	  'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')  // 加入 CSRF token
	},
      data: JSON.stringify({
        traces: traces  // 發送所有的 traces
      }),
      success: function(response) {
        console.log("Response:", response);
	const fig = JSON.parse(response.fig);
	
	// 使用 Plotly 渲染圖表
	Plotly.newPlot('interactive', fig.data, fig.layout).then(() => {
          document.getElementById('interactive').style.height = '100%';
        });
      },
      error: function(error) {
        console.error("Error generating plot: ", error);
      }
    }); 
  }
	

  // Z-score 計算函數
  function calculateZScores(values) {
    let mean = values.reduce((a, b) => a + b, 0) / values.length;
    let stdDev = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / values.length);
    return values.map(x => (x - mean) / stdDev);
  }
  

  // 創建離群值標記線條
  function createOutlierLines(trace, outlierIndices) {
    return outlierIndices.map(index => ({
      type: 'line',
      x0: trace.timestamps[index],
      x1: trace.timestamps[index],
      y0: 0, // Math.min(...trace.values),
      y1: Math.max(...trace.values),
      line: {
        color: 'red',
        width: 2,
        dash: 'dot'
      }
    }));
  }


  // 更新離群值圖表
  function updateOutlierChart(gd, trace, zscoreThreshold) {
    // 發送時間序列資料和 zscore 閾值到後端
    $.ajax({
      url: '/api/outlier_detection',
      type: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')  // 加入 CSRF token
      },
      data: JSON.stringify({ timestamps: trace.timestamps, values: trace.values, zscoreThreshold: zscoreThreshold }),
      success: function(response) {
        const outlierLines = createOutlierLines(trace, response.outlierIndices);
        // 更新 layout 中的 shapes (離群值標記線)
        Plotly.relayout(gd, { shapes: outlierLines });
      },
      error: function(xhr, status, error) {
        console.error('Error in outlier detection:', error);
      }
    });
  }
  
  
  // 初始繪製圖表的函數
  function outlier(traces, initialZscoreThreshold = 3) {
    traces.forEach(trace => {
      let areaTrace = {
        x: trace.timestamps,
        y: trace.values,
        mode: 'lines',
        fill: 'tozeroy',
        name: trace.field + ' - ' + trace.sensor
      };

      let layout = {
        title: 'Area Chart with Outliers',
        xaxis: { title: 'Time', tickformat: '%Y-%m-%d %H:%M:%S', tickangle: 45 },
        yaxis: { title: 'Value' }
      };

      // 渲染圖表
      Plotly.newPlot('interactive', [areaTrace], layout).then((gd) => {
        // 當輸入框的值改變時，更新離群值
        document.getElementById('zscore-input').addEventListener('input', (event) => {
          let zscoreThreshold = parseFloat(event.target.value);
          updateOutlierChart(gd, trace, zscoreThreshold);
        });

        // 初次渲染時也觸發一次 update
        updateOutlierChart(gd, trace, initialZscoreThreshold);
      });
    });
  }


  function getFormatDate(date) {
    let year = date.getFullYear();
    let month = '' + (date.getMonth() + 1);
    let day = '' + date.getDate();

    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;

    return [year, month, day].join('-');
  }
  
  var app = new Vue({
    el: '#app',
    data: function () {
      let initialFieldsSensors = {
        active_field: '',
        active_sensor: '',
        active_sensors: []
      };
      return {
        fields: {{ fields|safe }}, //Jinja2 模板語言中的語法，用來在 HTML 模板中插入變數或表達式的值。當模板被渲染時，變數的值會替換掉
        fieldsSensors: [Object.assign({}, initialFieldsSensors)],
        selectedMethod: 'line'  // 預設選擇的繪圖方法
      }
    },
    methods: {
      addFieldSensor() {
        this.fieldsSensors.push({
          active_field: '',
          active_sensor: '',
          active_sensors: []
        });
      },
      field_change(index) {
        let field = this.fieldsSensors[index].active_field;
        this.fieldsSensors[index].active_sensors = this.fields.find(f => f.name === field).sensors;
      },
      executeMethod() {
        if (this.selectedMethod === 'outlier') {
          let zscoreThreshold = 3;
          getTraces('area', (traces) => {
            outlier(traces, zscoreThreshold);
          });
        } else if (this.selectedMethod === 'stl') {
          getTraces(this.selectedMethod, stl);
        } else if (this.selectedMethod === 'correlation_matrix') {
            getTraces(this.selectedMethod, correlation_matrix);
        } else {
          // 調用外部的 getTraces 函數，並將選擇的繪圖方法和回調傳入
          getTraces(this.selectedMethod, visualization);  // `plot` 作為回調函數
        }
      }
    },
    mounted() {
      this.fieldsSensors[0].active_field = this.fields[0].name;
      this.fieldsSensors[0].active_sensors = this.fields[0].sensors;
      this.fieldsSensors[0].active_sensor = this.fields[0].sensors[0].df_name;

      // set default time
      let d = new Date();
      $('#end-time')[0].value = getFormatDate(d);
      d.setDate(d.getDate() - 1);
      $('#start-time')[0].value = getFormatDate(d);
    }
  });
</script>
{% endblock %}
